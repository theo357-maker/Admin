<!-- PWA Meta Tags -->
  <meta name="application-name" content="TheoVêt">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="TheoVêt">
  <meta name="description" content="Solution complète de gestion de commerce de vêtements">
  <meta name="format-detection" content="telephone=no">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="msapplication-TileColor" content="#3498db">
  <meta name="msapplication-tap-highlight" content="no">
  <meta name="theme-color" content="#3498db">

   <!-- Service Worker et mise à jour -->
    <meta name="version" content="2.1.0">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">

 
  <!-- Apple Touch Icons -->
  <link rel="apple-touch-icon" href="icon-192x192.png">
  <link rel="apple-touch-icon" sizes="192x192" href="icon-192x192.png">
  <link rel="apple-touch-icon" sizes="72x72" href="icon-72x72.png">
  <link rel="apple-touch-icon" sizes="167x167" href="icon-167x167.png">

  <!-- Manifest -->
  <link rel="manifest" href="manifest.json">

  <!-- Styles et Bibliothèques -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<!-- Scripts de mise à jour -->
<script src="update-system.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <style>
        :root {
            --primary: #3498db; --secondary: #2c3e50; --success: #27ae60;
            --danger: #e74c3c; --warning: #f39c12; --info: #1abc9c;
            --light: #ecf0f1; --dark: #34495e;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background-color: #f5f6fa; }
        .hidden { display: none !important; }
        
        /* Splash Screen */
        .splash-screen { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            z-index: 3000; color: white;
        }
        .splash-logo { 
            width: 150px; height: 150px; margin-bottom: 2rem;
            background: white; border-radius: 20px;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .splash-logo i { font-size: 4rem; color: var(--primary); }
        .loading-spinner {
            width: 50px; height: 50px;
            border: 5px solid rgba(255,255,255,0.3);
            border-top: 5px solid white; border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

/* Styles pour les notifications de mise à jour */
.update-toast {
  position: fixed;
  top: 20px;
  right: 20px;
  background: white;
  border-left: 4px solid #3498db;
  border-radius: 8px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.15);
  padding: 15px 20px;
  min-width: 300px;
  max-width: 400px;
  z-index: 9999;
  transform: translateX(120%);
  transition: transform 0.3s ease;
}

.update-toast.show {
  transform: translateX(0);
}

.update-toast.success {
  border-left-color: #27ae60;
}

.update-toast.warning {
  border-left-color: #f39c12;
}

.update-toast.danger {
  border-left-color: #e74c3c;
}
        
        /* Login Screen */
        .login-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.7); display: flex; justify-content: center; 
            align-items: center; z-index: 2000; 
        }
        .login-card { 
            background: white; padding: 3rem; border-radius: 10px; 
            width: 90%; max-width: 400px; text-align: center; 
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }
        .form-group { margin-bottom: 1.5rem; }
        .form-control { width: 100%; padding: 12px 15px; border: 2px solid #e1e8ed; border-radius: 8px; }
        .alert { padding: 1rem; border-radius: 5px; margin-bottom: 1rem; }
        .alert-error { background: #f8d7da; color: #721c24; }
        .alert-success { background: #d4edda; color: #155724; }
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: 500; color: white; }
        .btn-primary { background: var(--primary); }
        .btn-danger { background: var(--danger); }
        
        /* App Container */
        .app-container { display: flex; min-height: 100vh; }
        .sidebar { width: 250px; background: white; box-shadow: 2px 0 10px rgba(0,0,0,0.08); flex-shrink: 0; }
        .main-content { flex: 1; display: flex; flex-direction: column; }
        .app-header { background: white; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; }
        .content-area { padding: 2rem; }
        .page { display: none; }
        .page.active { display: block; }
        
        /* Sidebar Menu */
        .nav-menu { list-style: none; padding: 1rem 0; margin: 0; }
        .nav-menu li a { 
            display: flex; align-items: center; gap: 12px; padding: 14px 20px; 
            color: var(--dark); text-decoration: none; font-weight: 500; 
        }
        .nav-menu li a.active, .nav-menu li a:hover { background: #eaf5fc; color: var(--primary); }
        
        /* User Profile */
        .admin-profile { display: flex; align-items: center; gap: 1rem; }
        .admin-photo { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary); }
        .admin-photo-placeholder { width: 40px; height: 40px; border-radius: 50%; background: #eee; display: flex; align-items: center; justify-content: center; color: #999; }
        .menu-toggle { display: none; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--dark); }
        
        /* Dashboard Stats */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .stat-card { 
            background: white; padding: 1.5rem; border-radius: 8px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); text-align: center; 
            transition: transform 0.2s;
        }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-card i { font-size: 2rem; margin-bottom: 0.5rem; color: var(--primary); }
        .stat-card h3 { font-size: 1.8rem; margin: 0.5rem 0; }
        .stat-card p { color: #666; font-size: 0.9rem; }
        
        /* Card Styling */
        .card { background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 1.5rem; }
        
        /* Search Form */
        .search-form { background: white; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem; }
        .search-results { margin-top: 1.5rem; }
        .table-container { overflow-x: auto; margin-top: 1rem; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background-color: #f8f9fa; font-weight: 600; }
        tr:hover { background-color: #f8f9fa; }
        
        /* Badges */
        .badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: 500; }
        .badge-success { background-color: var(--success); color: white; }
        .badge-primary { background-color: var(--primary); color: white; }
        
        /* Finance Controls */
        .finance-controls { display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
        .finance-controls select, .finance-controls input { min-width: 150px; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; }
        .chart-container { background: white; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem; height: 400px; }
        
        /* AI Recommendations */
        .ai-recommendation { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;
        }
        .ai-icon { font-size: 2rem; margin-bottom: 1rem; }
        
        /* Settings */
        .photo-upload { text-align: center; margin: 1rem 0; }
        .photo-preview { width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 3px solid var(--primary); margin: 0 auto 1rem; display: block; }
        .photo-placeholder { width: 120px; height: 120px; border-radius: 50%; background: #eee; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem; color: #999; }
        .file-input { display: none; }
        .upload-btn { background: var(--info); color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; }
        
        /* Responsive */
        @media (max-width: 768px) {
            .menu-toggle { display: block; }
            .sidebar { position: fixed; z-index: 1000; height: 100%; transform: translateX(-100%); transition: transform 0.3s; }
            .sidebar.active { transform: translateX(0); }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .finance-controls { flex-direction: column; }
        }
        @media (max-width: 480px) {
            .stats-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
        <!-- Splash Screen -->
    <<!-- Écran de démarrage -->
    <div id="splash-screen" class="splash-screen">
        <div class="splash-logo">
            <i > <img src="hi.png" width="50px"></i>
        </div>
        <div class="splash-text">
            <h1>hybrilink</h1>
            <p>Portail admin</p>
        </div>
        <div class="loading-spinner"></div>
    </div>


    <!-- Login Screen -->
    <div id="login-overlay" class="login-overlay hidden">
        <div class="login-card">
            <h3>Connexion Administration</h3>
            <p>Veuillez vous connecter pour accéder au portail admin</p>
            <form id="login-form" style="margin-top: 2rem;">
                <div class="form-group">
                    <input type="email" id="login-email" class="form-control" placeholder="Adresse email" required>
                </div>
                <div class="form-group">
                    <input type="password" id="login-password" class="form-control" placeholder="Mot de passe" required>
                </div>
                <div id="login-alert" class="alert hidden" style="margin-top: 1rem;"></div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Connexion</button>
            </form>
        </div>
    </div>

    <!-- App Container -->
    <div id="app-root" class="app-container hidden">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div style="padding: 1.5rem; text-align: center; border-bottom: 1px solid #eee;">
                <i class="fas fa-user-shield" style="font-size: 2rem; color: var(--primary);"></i>
                <h3 style="margin-top: 0.5rem;">Administration</h3>
            </div>
            <ul class="nav-menu">
                <li><a href="#" class="active" data-page="dashboard"><i class="fas fa-tachometer-alt fa-fw"></i> Tableau de Bord</a></li>
                <li><a href="#" data-page="students"><i class="fas fa-user-graduate fa-fw"></i> Élèves</a></li>
                <li><a href="#" data-page="teachers"><i class="fas fa-chalkboard-teacher fa-fw"></i> Enseignants</a></li>
                <li><a href="#" data-page="finance"><i class="fas fa-chart-line fa-fw"></i> Finances</a></li>
                <li><a href="#" data-page="settings"><i class="fas fa-cog fa-fw"></i> Paramètres</a></li>
            </ul>
        </nav>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Header -->
            <header class="app-header">
                <button class="menu-toggle" id="menu-toggle">
                    <i class="fas fa-bars"></i>
                </button>
                <h2 id="page-title">Tableau de Bord</h2>
                <div class="admin-profile">
                    <div id="admin-photo-container">
                        <!-- Photo de profil dynamique -->
                    </div>
                    <span id="admin-name"></span>
                    <button id="logout-btn" class="btn btn-danger">Déconnexion</button>
                </div>
            </header>

            <!-- Content Area -->
            <main class="content-area">
                <div id="global-alert" class="alert hidden"></div>

                <!-- Dashboard Page -->
                <div id="dashboard-page" class="page active">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <i class="fas fa-users"></i>
                            <h3 id="total-students">0</h3>
                            <p>Élèves Totaux</p>
                        </div>
                        <div class="stat-card">
                            <i class="fas fa-user-tie"></i>
                            <h3 id="total-teachers">0</h3>
                            <p>Enseignants</p>
                        </div>
                        <div class="stat-card">
                            <i class="fas fa-money-bill-wave"></i>
                            <h3 id="total-revenue">$0</h3>
                            <p>Revenus Totaux</p>
                        </div>
                        <div class="stat-card">
                            <i class="fas fa-chart-pie"></i>
                            <h3 id="avg-payment">0%</h3>
                            <p>Taux de Paiement</p>
                        </div>
                    </div>

                    <div class="card">
                        <h4>Aperçu Rapide</h4>
                        <p>Bienvenue dans le portail d'administration hybrilink.</p>
                        <p>Utilisez le menu de navigation pour accéder aux différentes sections :</p>
                        <ul style="margin-top: 1rem; padding-left: 1.5rem;">
                            <li><strong>Élèves :</strong> Recherche d'élèves par matricule</li>
                            <li><strong>Enseignants :</strong> Statistiques par classe</li>
                            <li><strong>Finances :</strong> Rapports détaillés et analyse IA</li>
                            <li><strong>Paramètres :</strong> Gestion de votre profil</li>
                        </ul>
                    </div>
                </div>

                <!-- Students Page -->
                <div id="students-page" class="page">
                    <div class="card">
                        <h4>Recherche d'Élève par Matricule</h4>
                        <div class="search-form">
                            <div class="form-group">
                                <label>Entrez le matricule de l'élève</label>
                                <input type="text" id="student-matricule" class="form-control" placeholder="Ex: SEC2023001, PRI2023001, MAT2023001">
                            </div>
                            <button id="search-student-btn" class="btn btn-primary">Rechercher</button>
                        </div>

                        <div id="student-search-results" class="search-results hidden">
                            <h5>Résultats de la recherche</h5>
                            <div id="student-details"></div>
                        </div>
                    </div>

                    <div class="card">
                        <h4>Statistiques Globales des Élèves</h4>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <i class="fas fa-school"></i>
                                <h3 id="secondary-students">0</h3>
                                <p>Secondaire</p>
                            </div>
                            <div class="stat-card">
                                <i class="fas fa-child"></i>
                                <h3 id="primary-students">0</h3>
                                <p>Primaire</p>
                            </div>
                            <div class="stat-card">
                                <i class="fas fa-baby"></i>
                                <h3 id="kindergarten-students">0</h3>
                                <p>Maternelle</p>
                            </div>
                        </div>

                        <div style="margin-top: 2rem;">
                            <h5>Distribution par Classe</h5>
                            <div class="table-container">
                                <table id="students-by-class-table">
                                    <thead>
                                        <tr>
                                            <th>Classe</th>
                                            <th>Type</th>
                                            <th>Nombre d'Élèves</th>
                                            <th>Pourcentage</th>
                                        </tr>
                                    </thead>
                                    <tbody id="students-by-class-body"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Teachers Page -->
                <div id="teachers-page" class="page">
                    <div class="card">
                        <h4>Recherche d'Enseignant par Matricule</h4>
                        <div class="search-form">
                            <div class="form-group">
                                <label>Entrez le matricule de l'enseignant</label>
                                <input type="text" id="teacher-matricule" class="form-control" placeholder="Ex: ENS001, ENP001, ENM001">
                            </div>
                            <button id="search-teacher-btn" class="btn btn-primary">Rechercher</button>
                        </div>

                        <div id="teacher-search-results" class="search-results hidden">
                            <h5>Résultats de la recherche</h5>
                            <div id="teacher-details"></div>
                        </div>
                    </div>

                    <div class="card">
                        <h4>Statistiques des Enseignants</h4>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <i class="fas fa-chalkboard"></i>
                                <h3 id="secondary-teachers">0</h3>
                                <p>Secondaire</p>
                            </div>
                            <div class="stat-card">
                                <i class="fas fa-book"></i>
                                <h3 id="primary-teachers">0</h3>
                                <p>Primaire</p>
                            </div>
                            <div class="stat-card">
                                <i class="fas fa-puzzle-piece"></i>
                                <h3 id="kindergarten-teachers">0</h3>
                                <p>Maternelle</p>
                            </div>
                        </div>

                        <div style="margin-top: 2rem;">
                            <h5>Distribution par Matière/Secondaire</h5>
                            <div class="table-container">
                                <table id="teachers-by-subject-table">
                                    <thead>
                                        <tr>
                                            <th>Matière</th>
                                            <th>Nombre d'Enseignants</th>
                                            <th>Classes Couvertes</th>
                                        </tr>
                                    </thead>
                                    <tbody id="teachers-by-subject-body"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Finance Page -->
                <div id="finance-page" class="page">
                    <div class="card">
                        <h4>Rapport Financier</h4>
                        
                        <div class="finance-controls">
                            <select id="report-period" class="form-control">
                                <option value="daily">Journalier</option>
                                <option value="weekly">Hebdomadaire</option>
                                <option value="monthly" selected>Mensuel</option>
                                <option value="yearly">Annuel</option>
                                <option value="custom">Personnalisé</option>
                            </select>
                            
                            <div id="date-range-controls" class="hidden">
                                <input type="text" id="start-date" class="form-control" placeholder="Date début">
                                <input type="text" id="end-date" class="form-control" placeholder="Date fin">
                            </div>
                            
                            <select id="student-type-filter" class="form-control">
                                <option value="all">Tous les élèves</option>
                                <option value="secondary">Secondaire</option>
                                <option value="primary">Primaire</option>
                                <option value="kindergarten">Maternelle</option>
                            </select>
                            
                            <select id="fees-type-filter" class="form-control">
                                <option value="all">Tous les frais</option>
                                <option value="Frais scolaires">Frais scolaires</option>
                                <option value="Frais d'inscription">Frais d'inscription</option>
                                <option value="Frais de l'état">Frais de l'état</option>
                                <option value="Autres">Autres</option>
                            </select>
                            
                            <button id="generate-report-btn" class="btn btn-primary">Générer Rapport</button>
                        </div>
                    </div>

                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                            <h4>Statistiques Financières</h4>
                            <div>
                                <button id="export-pdf-btn" class="btn btn-danger">
                                    <i class="fas fa-file-pdf"></i> PDF
                                </button>
                                <button id="export-excel-btn" class="btn btn-success">
                                    <i class="fas fa-file-excel"></i> Excel
                                </button>
                                <button id="export-csv-btn" class="btn btn-primary">
                                    <i class="fas fa-file-csv"></i> CSV
                                </button>
                            </div>
                        </div>

                        <div class="stats-grid">
                            <div class="stat-card">
                                <i class="fas fa-money-check-alt"></i>
                                <h3 id="total-amount">$0</h3>
                                <p>Montant Total</p>
                            </div>
                            <div class="stat-card">
                                <i class="fas fa-cash-register"></i>
                                <h3 id="total-transactions">0</h3>
                                <p>Transactions</p>
                            </div>
                            <div class="stat-card">
                                <i class="fas fa-chart-bar"></i>
                                <h3 id="avg-transaction">$0</h3>
                                <p>Moyenne/Transaction</p>
                            </div>
                            <div class="stat-card">
                                <i class="fas fa-percentage"></i>
                                <h3 id="payment-rate">0%</h3>
                                <p>Taux de Paiement</p>
                            </div>
                        </div>

                        <div class="chart-container">
                            <canvas id="finance-chart"></canvas>
                        </div>

                        <div class="table-container">
                            <table id="finance-details-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Type Élève</th>
                                        <th>Type Frais</th>
                                        <th>Classe</th>
                                        <th>Montant</th>
                                        <th>Méthode</th>
                                    </tr>
                                </thead>
                                <tbody id="finance-details-body"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- AI Recommendations -->
                    <div id="ai-recommendation-card" class="ai-recommendation hidden">
                        <div class="ai-icon">
                            <i class="fas fa-robot"></i>
                        </div>
                        <h4>Recommandation IA</h4>
                        <div id="ai-recommendation-text"></div>
                        <small style="opacity: 0.8; display: block; margin-top: 1rem;">
                            <i class="fas fa-info-circle"></i> Analyse basée sur les données historiques
                        </small>
                    </div>
                </div>

                <!-- Settings Page -->
                <div id="settings-page" class="page">
                    <div class="card">
                        <h4>Mon Profil Administrateur</h4>
                        <div style="display: flex; gap: 2rem;">
                            <div style="flex: 1;">
                                <div class="photo-upload">
                                    <div class="photo-placeholder" id="profile-photo-preview">
                                        <i class="fas fa-user-shield"></i>
                                    </div>
                                    <input type="file" id="profile-photo" class="file-input" accept="image/*">
                                    <button type="button" class="upload-btn" onclick="document.getElementById('profile-photo').click()">
                                        <i class="fas fa-upload"></i> Changer la photo
                                    </button>
                                </div>
                            </div>
                            <div style="flex: 2;">
                                <div class="form-group">
                                    <label>Nom Complet</label>
                                    <input type="text" id="profile-name" class="form-control" readonly>
                                </div>
                                <div class="form-group">
                                    <label>Email</label>
                                    <input type="email" id="profile-email" class="form-control" readonly>
                                </div>
                                <div class="form-group">
                                    <label>Rôle</label>
                                    <input type="text" id="profile-role" class="form-control" value="Administrateur" readonly>
                                </div>
                                <div class="form-group">
                                    <label>Date d'inscription</label>
                                    <input type="text" id="profile-created" class="form-control" readonly>
                                </div>
                                <button id="update-profile-btn" class="btn btn-primary">Mettre à jour le profil</button>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <h4>Statistiques d'Accès</h4>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <i class="fas fa-sign-in-alt"></i>
                                <h3 id="last-login">-</h3>
                                <p>Dernière Connexion</p>
                            </div>
                            <div class="stat-card">
                                <i class="fas fa-calendar-alt"></i>
                                <h3 id="total-logins">0</h3>
                                <p>Connexions Total</p>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script type="module">
        // 1. INITIALISATION DE FIREBASE
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, query, where, doc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

        // Configuration Firebase
        const firebaseConfig = {
          apiKey: "AIzaSyBn7VIddclO7KtrXb5sibCr9SjVLjOy-qI",
          authDomain: "theo1d.firebaseapp.com",
          projectId: "theo1d",
          storageBucket: "theo1d.firebasestorage.app",
          messagingSenderId: "269629842962",
          appId: "1:269629842962:web:a80a12b04448fe1e595acb",
          measurementId: "G-TNSG1XFMDZ"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Variables globales
        let currentAdmin = null;
        let financeChart = null;

        // 2. ÉCRAN DE DÉMARRAGE
        setTimeout(() => {
            document.getElementById('splash-screen').classList.add('hidden');
            checkAuthentication();
        }, 2000);

        // 3. AUTHENTIFICATION
        function checkAuthentication() {
            const user = auth.currentUser;
            if (user) {
                initializeAdminPortal(user);
            } else {
                document.getElementById('login-overlay').classList.remove('hidden');
            }
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                try {
                    // Vérifier si c'est un administrateur
                    const q = query(collection(db, 'admin'), where('uid', '==', user.uid));
                    const snap = await getDocs(q);
                    
                    if (snap.empty) {
                        // Si pas administrateur, déconnecter
                        await signOut(auth);
                        showLoginAlert("Accès réservé aux administrateurs", "error");
                        return;
                    }
                    
                    currentAdmin = { id: snap.docs[0].id, ...snap.docs[0].data() };
                    document.getElementById('login-overlay').classList.add('hidden');
                    document.getElementById('app-root').classList.remove('hidden');
                    
                    // Mettre à jour l'interface
                    document.getElementById('admin-name').textContent = currentAdmin.fullName;
                    updateAdminPhoto(currentAdmin.photoURL);
                    loadProfileData();
                    initializeAdminPortal();
                    
                } catch (error) {
                    console.error("Erreur initialisation admin:", error);
                    showLoginAlert("Erreur d'accès", "error");
                }
            } else {
                document.getElementById('login-overlay').classList.remove('hidden');
                document.getElementById('app-root').classList.add('hidden');
            }
        });

        function showLoginAlert(message, type = 'info') {
            const alertBox = document.getElementById('login-alert');
            alertBox.textContent = message;
            alertBox.className = `alert alert-${type}`;
            alertBox.classList.remove('hidden');
            setTimeout(() => alertBox.classList.add('hidden'), 5000);
        }

        // Connexion
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Connexion...';
            submitBtn.disabled = true;

            try {
                await signInWithEmailAndPassword(auth, email, password);
                showLoginAlert("Connexion réussie", "success");
            } catch (error) {
                console.error("Erreur connexion:", error);
                let errorMessage = "Email ou mot de passe incorrect.";
                if (error.code === 'auth/user-not-found') {
                    errorMessage = "Aucun compte administrateur trouvé.";
                } else if (error.code === 'auth/wrong-password') {
                    errorMessage = "Mot de passe incorrect.";
                }
                showLoginAlert(errorMessage, "error");
            } finally {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        });

        // Déconnexion
        document.getElementById('logout-btn').addEventListener('click', () => {
            signOut(auth);
            showAlert("Déconnexion réussie", "success");
        });

        // 4. INITIALISATION DU PORTAL ADMIN
        function initializeAdminPortal() {
            loadDashboardStats();
            setupDatePicker();
            setupEventListeners();
            setupNavigation();
            
            // Initialiser Flatpickr
            flatpickr("#start-date", { dateFormat: "Y-m-d" });
            flatpickr("#end-date", { dateFormat: "Y-m-d" });
        }

        function setupEventListeners() {
            // Recherche élève
            document.getElementById('search-student-btn').addEventListener('click', searchStudentByMatricule);
            
            // Recherche enseignant
            document.getElementById('search-teacher-btn').addEventListener('click', searchTeacherByMatricule);
            
            // Génération rapport
            document.getElementById('generate-report-btn').addEventListener('click', generateFinancialReport);
            
            // Export
            document.getElementById('export-pdf-btn').addEventListener('click', exportToPDF);
            document.getElementById('export-excel-btn').addEventListener('click', exportToExcel);
            document.getElementById('export-csv-btn').addEventListener('click', exportToCSV);
            
            // Mise à jour profil
            document.getElementById('update-profile-btn').addEventListener('click', updateAdminProfile);
            
            // Gestion photo profil
            document.getElementById('profile-photo').addEventListener('change', handleProfilePhotoChange);
            
            // Menu mobile
            document.getElementById('menu-toggle').addEventListener('click', () => {
                document.querySelector('.sidebar').classList.toggle('active');
            });
            
            // Gestion période rapport
            document.getElementById('report-period').addEventListener('change', function() {
                const dateRangeControls = document.getElementById('date-range-controls');
                if (this.value === 'custom') {
                    dateRangeControls.classList.remove('hidden');
                } else {
                    dateRangeControls.classList.add('hidden');
                }
            });
        }

        function setupNavigation() {
            document.querySelectorAll('.nav-menu a').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    
                    // Mettre à jour le menu actif
                    document.querySelectorAll('.nav-menu a, .page').forEach(el => el.classList.remove('active'));
                    link.classList.add('active');
                    
                    // Afficher la page correspondante
                    const pageId = link.dataset.page + '-page';
                    document.getElementById(pageId).classList.add('active');
                    document.getElementById('page-title').textContent = link.textContent;
                    
                    // Fermer le menu sur mobile
                    if (window.innerWidth <= 768) {
                        document.querySelector('.sidebar').classList.remove('active');
                    }
                    
                    // Charger les données spécifiques à la page
                    switch(link.dataset.page) {
                        case 'dashboard':
                            loadDashboardStats();
                            break;
                        case 'students':
                            loadStudentStatistics();
                            break;
                        case 'teachers':
                            loadTeacherStatistics();
                            break;
                        case 'finance':
                            generateFinancialReport();
                            break;
                        case 'settings':
                            loadProfileData();
                            break;
                    }
                });
            });
        }

        // 5. FONCTIONS UTILITAIRES
        function showAlert(message, type = 'info') {
            const alertBox = document.getElementById('global-alert');
            alertBox.textContent = message;
            alertBox.className = `alert alert-${type}`;
            alertBox.classList.remove('hidden');
            setTimeout(() => alertBox.classList.add('hidden'), 5000);
        }

        function formatDate(date) {
            if (!date) return 'Non définie';
            return date.toLocaleDateString('fr-FR', { 
                day: '2-digit', 
                month: '2-digit', 
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('fr-FR', {
                style: 'currency',
                currency: 'USD'
            }).format(amount);
        }

        function updateAdminPhoto(photoURL) {
            const container = document.getElementById('admin-photo-container');
            if (photoURL) {
                container.innerHTML = `<img src="${photoURL}" class="admin-photo" alt="Photo de profil">`;
            } else {
                container.innerHTML = `<div class="admin-photo-placeholder"><i class="fas fa-user-shield"></i></div>`;
            }
        }

        // 6. TABLEAU DE BORD
        async function loadDashboardStats() {
            try {
                // Compter les élèves
                const secondaryStudents = await getDocs(collection(db, 'students'));
                const primaryStudents = await getDocs(collection(db, 'primary_students'));
                const kindergartenStudents = await getDocs(collection(db, 'kindergarten_students'));
                
                const totalStudents = secondaryStudents.size + primaryStudents.size + kindergartenStudents.size;
                document.getElementById('total-students').textContent = totalStudents;
                
                // Compter les enseignants
                const secondaryTeachers = await getDocs(collection(db, 'teachers'));
                const primaryTeachers = await getDocs(collection(db, 'primary_teachers'));
                const kindergartenTeachers = await getDocs(collection(db, 'kindergarten_teachers'));
                
                const totalTeachers = secondaryTeachers.size + primaryTeachers.size + kindergartenTeachers.size;
                document.getElementById('total-teachers').textContent = totalTeachers;
                
                // Calculer les revenus
                const payments = await getDocs(collection(db, 'payments'));
                let totalRevenue = 0;
                payments.forEach(doc => {
                    const data = doc.data();
                    totalRevenue += data.amount || 0;
                });
                
                document.getElementById('total-revenue').textContent = formatCurrency(totalRevenue);
                
                // Calculer le taux de paiement
                const allStudents = totalStudents;
                const paidStudents = await calculatePaidStudents();
                const paymentRate = allStudents > 0 ? Math.round((paidStudents / allStudents) * 100) : 0;
                
                document.getElementById('avg-payment').textContent = paymentRate + '%';
                
            } catch (error) {
                console.error('Erreur chargement stats:', error);
            }
        }

        async function calculatePaidStudents() {
            try {
                const payments = await getDocs(collection(db, 'payments'));
                const paidStudents = new Set();
                
                payments.forEach(doc => {
                    const data = doc.data();
                    if (data.studentId) {
                        paidStudents.add(data.studentId);
                    }
                });
                
                return paidStudents.size;
            } catch (error) {
                console.error('Erreur calcul étudiants payés:', error);
                return 0;
            }
        }

        // 7. GESTION DES ÉLÈVES
        async function loadStudentStatistics() {
            try {
                // Compter par type
                const secondaryStudents = await getDocs(collection(db, 'students'));
                const primaryStudents = await getDocs(collection(db, 'primary_students'));
                const kindergartenStudents = await getDocs(collection(db, 'kindergarten_students'));
                
                document.getElementById('secondary-students').textContent = secondaryStudents.size;
                document.getElementById('primary-students').textContent = primaryStudents.size;
                document.getElementById('kindergarten-students').textContent = kindergartenStudents.size;
                
                // Distribution par classe
                await loadStudentsByClass();
                
            } catch (error) {
                console.error('Erreur stats élèves:', error);
            }
        }

        async function loadStudentsByClass() {
            const tbody = document.getElementById('students-by-class-body');
            tbody.innerHTML = '<tr><td colspan="4">Chargement...</td></tr>';
            
            try {
                // Récupérer toutes les classes
                const secondaryClasses = await getDocs(collection(db, 'classes'));
                const primaryClasses = await getDocs(collection(db, 'primary_classes'));
                const kindergartenClasses = await getDocs(collection(db, 'kindergarten_classes'));
                
                let html = '';
                let totalStudents = 0;
                
                // Traiter les classes secondaires
                for (const classDoc of secondaryClasses.docs) {
                    const classData = classDoc.data();
                    const studentsCount = await countStudentsInClass('students', classData.name);
                    totalStudents += studentsCount;
                    
                    html += `
                        <tr>
                            <td>${classData.name}</td>
                            <td><span class="badge badge-primary">Secondaire</span></td>
                            <td>${studentsCount}</td>
                            <td>${totalStudents > 0 ? Math.round((studentsCount / totalStudents) * 100) : 0}%</td>
                        </tr>
                    `;
                }
                
                // Traiter les classes primaires
                for (const classDoc of primaryClasses.docs) {
                    const classData = classDoc.data();
                    const studentsCount = await countStudentsInClass('primary_students', classData.name);
                    totalStudents += studentsCount;
                    
                    html += `
                        <tr>
                            <td>${classData.name}</td>
                            <td><span class="badge badge-success">Primaire</span></td>
                            <td>${studentsCount}</td>
                            <td>${totalStudents > 0 ? Math.round((studentsCount / totalStudents) * 100) : 0}%</td>
                        </tr>
                    `;
                }
                
                // Traiter les classes maternelles
                for (const classDoc of kindergartenClasses.docs) {
                    const classData = classDoc.data();
                    const studentsCount = await countStudentsInClass('kindergarten_students', classData.name);
                    totalStudents += studentsCount;
                    
                    html += `
                        <tr>
                            <td>${classData.name}</td>
                            <td><span class="badge badge-info">Maternelle</span></td>
                            <td>${studentsCount}</td>
                            <td>${totalStudents > 0 ? Math.round((studentsCount / totalStudents) * 100) : 0}%</td>
                        </tr>
                    `;
                }
                
                tbody.innerHTML = html || '<tr><td colspan="4">Aucune donnée</td></tr>';
                
            } catch (error) {
                console.error('Erreur distribution classes:', error);
                tbody.innerHTML = '<tr><td colspan="4">Erreur de chargement</td></tr>';
            }
        }

        async function countStudentsInClass(collectionName, className) {
            try {
                const studentsQuery = query(collection(db, collectionName), where('class', '==', className));
                const studentsSnap = await getDocs(studentsQuery);
                return studentsSnap.size;
            } catch (error) {
                return 0;
            }
        }

        async function searchStudentByMatricule() {
            const matricule = document.getElementById('student-matricule').value.trim();
            if (!matricule) {
                showAlert("Veuillez entrer un matricule", "error");
                return;
            }
            
            const resultsContainer = document.getElementById('student-search-results');
            const detailsContainer = document.getElementById('student-details');
            
            resultsContainer.classList.add('hidden');
            detailsContainer.innerHTML = '<p>Recherche en cours...</p>';
            
            try {
                let studentData = null;
                let collectionName = '';
                
                // Déterminer le type d'élève par le préfixe du matricule
                if (matricule.startsWith('SEC')) {
                    collectionName = 'students';
                } else if (matricule.startsWith('PRI')) {
                    collectionName = 'primary_students';
                } else if (matricule.startsWith('MAT')) {
                    collectionName = 'kindergarten_students';
                } else {
                    showAlert("Format de matricule invalide", "error");
                    return;
                }
                
                const studentDoc = await getDoc(doc(db, collectionName, matricule));
                
                if (studentDoc.exists()) {
                    studentData = studentDoc.data();
                    
                    // Récupérer les paiements de l'élève
                    const paymentsQuery = query(collection(db, 'payments'), where('studentId', '==', matricule));
                    const paymentsSnap = await getDocs(paymentsQuery);
                    let totalPaid = 0;
                    let paymentsHTML = '';
                    
                    paymentsSnap.forEach(paymentDoc => {
                        const payment = paymentDoc.data();
                        totalPaid += payment.amount || 0;
                        paymentsHTML += `
                            <tr>
                                <td>${formatDate(payment.validatedAt?.toDate())}</td>
                                <td>${payment.paymentType || 'Non spécifié'}</td>
                                <td>${payment.month || 'Non spécifié'}</td>
                                <td>${formatCurrency(payment.amount || 0)}</td>
                            </tr>
                        `;
                    });
                    
                    const studentType = collectionName === 'students' ? 'Secondaire' : 
                                     collectionName === 'primary_students' ? 'Primaire' : 'Maternelle';
                    
                    detailsContainer.innerHTML = `
                        <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem;">
                            <div style="display: flex; gap: 2rem; align-items: center;">
                                ${studentData.photoURL ? 
                                    `<img src="${studentData.photoURL}" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover;">` : 
                                    '<div style="width: 100px; height: 100px; border-radius: 50%; background: #eee; display: flex; align-items: center; justify-content: center;"><i class="fas fa-user" style="font-size: 2rem; color: #999;"></i></div>'
                                }
                                <div>
                                    <h4>${studentData.fullName}</h4>
                                    <p><strong>Matricule:</strong> ${studentData.matricule}</p>
                                    <p><strong>Classe:</strong> ${studentData.class}</p>
                                    <p><strong>Type:</strong> ${studentType}</p>
                                    <p><strong>Total payé:</strong> ${formatCurrency(totalPaid)}</p>
                                </div>
                            </div>
                        </div>
                        
                        <h5>Historique des Paiements</h5>
                        ${paymentsSnap.empty ? 
                            '<p>Aucun paiement enregistré</p>' : 
                            `<div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Type</th>
                                            <th>Mois</th>
                                            <th>Montant</th>
                                        </tr>
                                    </thead>
                                    <tbody>${paymentsHTML}</tbody>
                                </table>
                            </div>`
                        }
                    `;
                    
                    resultsContainer.classList.remove('hidden');
                    
                } else {
                    showAlert("Aucun élève trouvé avec ce matricule", "error");
                    detailsContainer.innerHTML = '<p>Aucun résultat</p>';
                }
                
            } catch (error) {
                console.error('Erreur recherche élève:', error);
                showAlert("Erreur lors de la recherche", "error");
                detailsContainer.innerHTML = '<p>Erreur de recherche</p>';
            }
        }

        // 8. GESTION DES ENSEIGNANTS
        async function loadTeacherStatistics() {
            try {
                // Compter par type
                const secondaryTeachers = await getDocs(collection(db, 'teachers'));
                const primaryTeachers = await getDocs(collection(db, 'primary_teachers'));
                const kindergartenTeachers = await getDocs(collection(db, 'kindergarten_teachers'));
                
                document.getElementById('secondary-teachers').textContent = secondaryTeachers.size;
                document.getElementById('primary-teachers').textContent = primaryTeachers.size;
                document.getElementById('kindergarten-teachers').textContent = kindergartenTeachers.size;
                
                // Distribution par matière
                await loadTeachersBySubject();
                
            } catch (error) {
                console.error('Erreur stats enseignants:', error);
            }
        }

        async function loadTeachersBySubject() {
            const tbody = document.getElementById('teachers-by-subject-body');
            tbody.innerHTML = '<tr><td colspan="3">Chargement...</td></tr>';
            
            try {
                const teachersSnap = await getDocs(collection(db, 'teachers'));
                const subjectCount = {};
                const classCoverage = {};
                
                teachersSnap.forEach(doc => {
                    const data = doc.data();
                    if (data.subjects && Array.isArray(data.subjects)) {
                        data.subjects.forEach(subject => {
                            subject = subject.trim();
                            if (!subjectCount[subject]) {
                                subjectCount[subject] = 0;
                                classCoverage[subject] = new Set();
                            }
                            subjectCount[subject]++;
                            
                            if (data.classes && Array.isArray(data.classes)) {
                                data.classes.forEach(cls => classCoverage[subject].add(cls));
                            }
                        });
                    }
                });
                
                let html = '';
                for (const [subject, count] of Object.entries(subjectCount)) {
                    const coverage = Array.from(classCoverage[subject] || []).join(', ');
                    html += `
                        <tr>
                            <td>${subject}</td>
                            <td>${count}</td>
                            <td>${coverage || 'Non spécifié'}</td>
                        </tr>
                    `;
                }
                
                tbody.innerHTML = html || '<tr><td colspan="3">Aucune donnée</td></tr>';
                
            } catch (error) {
                console.error('Erreur distribution matières:', error);
                tbody.innerHTML = '<tr><td colspan="3">Erreur de chargement</td></tr>';
            }
        }

        async function searchTeacherByMatricule() {
            const matricule = document.getElementById('teacher-matricule').value.trim();
            if (!matricule) {
                showAlert("Veuillez entrer un matricule", "error");
                return;
            }
            
            const resultsContainer = document.getElementById('teacher-search-results');
            const detailsContainer = document.getElementById('teacher-details');
            
            resultsContainer.classList.add('hidden');
            detailsContainer.innerHTML = '<p>Recherche en cours...</p>';
            
            try {
                let teacherData = null;
                let collectionName = '';
                
                // Déterminer le type d'enseignant par le préfixe
                if (matricule.startsWith('ENS')) {
                    collectionName = 'teachers';
                } else if (matricule.startsWith('ENP')) {
                    collectionName = 'primary_teachers';
                } else if (matricule.startsWith('ENM')) {
                    collectionName = 'kindergarten_teachers';
                } else {
                    showAlert("Format de matricule invalide", "error");
                    return;
                }
                
                const teacherDoc = await getDoc(doc(db, collectionName, matricule));
                
                if (teacherDoc.exists()) {
                    teacherData = teacherDoc.data();
                    
                    const teacherType = collectionName === 'teachers' ? 'Secondaire' : 
                                     collectionName === 'primary_teachers' ? 'Primaire' : 'Maternelle';
                    
                    detailsContainer.innerHTML = `
                        <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem;">
                            <div style="display: flex; gap: 2rem; align-items: center;">
                                ${teacherData.photoURL ? 
                                    `<img src="${teacherData.photoURL}" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover;">` : 
                                    '<div style="width: 100px; height: 100px; border-radius: 50%; background: #eee; display: flex; align-items: center; justify-content: center;"><i class="fas fa-user-tie" style="font-size: 2rem; color: #999;"></i></div>'
                                }
                                <div>
                                    <h4>${teacherData.fullName}</h4>
                                    <p><strong>Matricule:</strong> ${teacherData.matricule}</p>
                                    <p><strong>Type:</strong> ${teacherType}</p>
                                    <p><strong>Téléphone:</strong> ${teacherData.phone || 'Non spécifié'}</p>
                                    <p><strong>Classes:</strong> ${teacherData.classes ? teacherData.classes.join(', ') : 'Non spécifié'}</p>
                                    ${teacherData.subjects ? `<p><strong>Matières:</strong> ${teacherData.subjects.join(', ')}</p>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                    
                    resultsContainer.classList.remove('hidden');
                    
                } else {
                    showAlert("Aucun enseignant trouvé avec ce matricule", "error");
                    detailsContainer.innerHTML = '<p>Aucun résultat</p>';
                }
                
            } catch (error) {
                console.error('Erreur recherche enseignant:', error);
                showAlert("Erreur lors de la recherche", "error");
                detailsContainer.innerHTML = '<p>Erreur de recherche</p>';
            }
        }

        // 9. GESTION FINANCIÈRE
        function setupDatePicker() {
            const today = new Date();
            const lastMonth = new Date();
            lastMonth.setMonth(lastMonth.getMonth() - 1);
            
            flatpickr("#start-date", {
                dateFormat: "Y-m-d",
                defaultDate: lastMonth
            });
            
            flatpickr("#end-date", {
                dateFormat: "Y-m-d",
                defaultDate: today
            });
        }

        async function generateFinancialReport() {
            try {
                showAlert("Génération du rapport en cours...", "info");
                
                const period = document.getElementById('report-period').value;
                const studentType = document.getElementById('student-type-filter').value;
                const feesType = document.getElementById('fees-type-filter').value;
                const startDate = document.getElementById('start-date').value;
                const endDate = document.getElementById('end-date').value;
                
                // Récupérer les paiements avec filtres
                let paymentsQuery = collection(db, 'payments');
                const paymentsSnap = await getDocs(paymentsQuery);
                
                let filteredPayments = [];
                let totalAmount = 0;
                let transactions = 0;
                
                paymentsSnap.forEach(doc => {
                    const payment = doc.data();
                    let include = true;
                    
                    // Filtrer par type d'élève
                    if (studentType !== 'all' && payment.studentType !== studentType) {
                        include = false;
                    }
                    
                    // Filtrer par type de frais
                    if (feesType !== 'all' && payment.paymentType !== feesType) {
                        include = false;
                    }
                    
                    // Filtrer par période
                    if (period === 'custom' && startDate && endDate) {
                        const paymentDate = payment.validatedAt?.toDate();
                        if (paymentDate) {
                            const paymentDateStr = paymentDate.toISOString().split('T')[0];
                            if (paymentDateStr < startDate || paymentDateStr > endDate) {
                                include = false;
                            }
                        }
                    }
                    
                    if (include) {
                        filteredPayments.push(payment);
                        totalAmount += payment.amount || 0;
                        transactions++;
                    }
                });
                
                // Mettre à jour les statistiques
                document.getElementById('total-amount').textContent = formatCurrency(totalAmount);
                document.getElementById('total-transactions').textContent = transactions;
                document.getElementById('avg-transaction').textContent = formatCurrency(transactions > 0 ? totalAmount / transactions : 0);
                
                // Calculer le taux de paiement
                const allStudents = await countAllStudents();
                const paidStudents = await calculatePaidStudents();
                const paymentRate = allStudents > 0 ? Math.round((paidStudents / allStudents) * 100) : 0;
                document.getElementById('payment-rate').textContent = paymentRate + '%';
                
                // Mettre à jour le tableau des détails
                updateFinanceDetailsTable(filteredPayments);
                
                // Générer le graphique
                generateFinanceChart(filteredPayments);
                
                // Générer les recommandations IA
                generateAIRecommendations(filteredPayments, totalAmount, transactions);
                
                showAlert("Rapport généré avec succès", "success");
                
            } catch (error) {
                console.error('Erreur génération rapport:', error);
                showAlert("Erreur lors de la génération du rapport", "error");
            }
        }

        async function countAllStudents() {
            const secondary = await getDocs(collection(db, 'students'));
            const primary = await getDocs(collection(db, 'primary_students'));
            const kindergarten = await getDocs(collection(db, 'kindergarten_students'));
            return secondary.size + primary.size + kindergarten.size;
        }

        function updateFinanceDetailsTable(payments) {
            const tbody = document.getElementById('finance-details-body');
            
            if (payments.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6">Aucune transaction trouvée</td></tr>';
                return;
            }
            
            let html = '';
            payments.sort((a, b) => (b.validatedAt?.toDate() || 0) - (a.validatedAt?.toDate() || 0));
            
            payments.forEach(payment => {
                const studentTypeText = payment.studentType === 'secondary' ? 'Secondaire' :
                                     payment.studentType === 'primary' ? 'Primaire' : 'Maternelle';
                
                html += `
                    <tr>
                        <td>${formatDate(payment.validatedAt?.toDate())}</td>
                        <td>${studentTypeText}</td>
                        <td>${payment.paymentType || 'Non spécifié'}</td>
                        <td>${payment.studentClass || 'Non spécifié'}</td>
                        <td>${formatCurrency(payment.amount || 0)}</td>
                        <td>${payment.paymentMethod === 'online' ? 'En ligne' : 'Sur place'}</td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }

        function generateFinanceChart(payments) {
            const ctx = document.getElementById('finance-chart').getContext('2d');
            
            // Détruire le graphique existant
            if (financeChart) {
                financeChart.destroy();
            }
            
            // Regrouper par mois
            const monthlyData = {};
            const typeData = {};
            const studentTypeData = {};
            
            payments.forEach(payment => {
                const date = payment.validatedAt?.toDate();
                if (date) {
                    const monthKey = `${date.getFullYear()}-${date.getMonth() + 1}`;
                    if (!monthlyData[monthKey]) monthlyData[monthKey] = 0;
                    monthlyData[monthKey] += payment.amount || 0;
                }
                
                // Par type de frais
                const feeType = payment.paymentType || 'Autres';
                if (!typeData[feeType]) typeData[feeType] = 0;
                typeData[feeType] += payment.amount || 0;
                
                // Par type d'élève
                const studentType = payment.studentType || 'secondary';
                const studentTypeText = studentType === 'secondary' ? 'Secondaire' :
                                     studentType === 'primary' ? 'Primaire' : 'Maternelle';
                if (!studentTypeData[studentTypeText]) studentTypeData[studentTypeText] = 0;
                studentTypeData[studentTypeText] += payment.amount || 0;
            });
            
            // Créer le graphique combiné
            financeChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Object.keys(monthlyData).sort(),
                    datasets: [{
                        label: 'Revenus par mois',
                        data: Object.keys(monthlyData).sort().map(key => monthlyData[key]),
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Évolution des revenus'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value;
                                }
                            }
                        }
                    }
                }
            });
        }

        function generateAIRecommendations(payments, totalAmount, transactions) {
            const aiCard = document.getElementById('ai-recommendation-card');
            const aiText = document.getElementById('ai-recommendation-text');
            
            if (payments.length === 0) {
                aiCard.classList.add('hidden');
                return;
            }
            
            aiCard.classList.remove('hidden');
            
            // Analyser les données
            const avgTransaction = transactions > 0 ? totalAmount / transactions : 0;
            const today = new Date();
            const lastMonth = new Date();
            lastMonth.setMonth(lastMonth.getMonth() - 1);
            
            // Filtrer les paiements du dernier mois
            const lastMonthPayments = payments.filter(p => {
                const date = p.validatedAt?.toDate();
                return date && date >= lastMonth;
            });
            
            const lastMonthAmount = lastMonthPayments.reduce((sum, p) => sum + (p.amount || 0), 0);
            const previousMonthAmount = totalAmount - lastMonthAmount;
            
            let recommendation = "";
            
            if (lastMonthAmount > previousMonthAmount) {
                const increase = ((lastMonthAmount - previousMonthAmount) / previousMonthAmount * 100).toFixed(1);
                recommendation = `📈 <strong>Croissance positive détectée !</strong> Les revenus ont augmenté de ${increase}% par rapport au mois précédent.`;
                
                if (avgTransaction < 100) {
                    recommendation += `<br>💡 <strong>Recommandation :</strong> Le montant moyen par transaction (${formatCurrency(avgTransaction)}) est bas. Pensez à proposer des forfaits groupés pour augmenter la valeur moyenne des transactions.`;
                }
            } else if (lastMonthAmount < previousMonthAmount) {
                const decrease = ((previousMonthAmount - lastMonthAmount) / previousMonthAmount * 100).toFixed(1);
                recommendation = `📉 <strong>Attention baisse détectée !</strong> Les revenus ont diminué de ${decrease}% par rapport au mois précédent.`;
                recommendation += `<br>💡 <strong>Recommandation :</strong> Identifiez les classes avec le plus faible taux de paiement et mettez en place des relances ciblées.`;
            } else {
                recommendation = `📊 <strong>Stabilité des revenus</strong> constatée sur la période analysée.`;
            }
            
            // Analyser la distribution par type de frais
            const feeTypes = {};
            payments.forEach(p => {
                const type = p.paymentType || 'Autres';
                if (!feeTypes[type]) feeTypes[type] = 0;
                feeTypes[type] += p.amount || 0;
            });
            
            const mainFeeType = Object.keys(feeTypes).reduce((a, b) => feeTypes[a] > feeTypes[b] ? a : b);
            const mainFeePercentage = (feeTypes[mainFeeType] / totalAmount * 100).toFixed(1);
            
            recommendation += `<br>🎯 <strong>Concentration :</strong> ${mainFeePercentage}% des revenus proviennent des "${mainFeeType}".`;
            recommendation += `<br>🔄 <strong>Suggestion :</strong> Diversifiez les sources de revenus en promouvant les autres types de frais.`;
            
            // Ajouter une recommandation basée sur le jour de la semaine
            const dayOfWeekCount = {};
            payments.forEach(p => {
                const date = p.validatedAt?.toDate();
                if (date) {
                    const day = date.getDay();
                    if (!dayOfWeekCount[day]) dayOfWeekCount[day] = 0;
                    dayOfWeekCount[day] += p.amount || 0;
                }
            });
            
            const bestDay = Object.keys(dayOfWeekCount).reduce((a, b) => dayOfWeekCount[a] > dayOfWeekCount[b] ? a : b);
            const days = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
            
            recommendation += `<br>📅 <strong>Optimisation :</strong> Le ${days[bestDay]} est le jour où les paiements sont les plus élevés. Planifiez les relances pour ce jour.`;
            
            aiText.innerHTML = recommendation;
        }

        // 10. EXPORT DES DONNÉES
        function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(16);
            doc.text('Rapport Financier - hybrilink', 14, 15);
            doc.setFontSize(10);
            doc.text(`Généré le: ${new Date().toLocaleDateString('fr-FR')}`, 14, 22);
            doc.text(`Par: ${currentAdmin.fullName}`, 14, 28);
            
            // Ajouter les statistiques
            doc.setFontSize(12);
            doc.text('Statistiques:', 14, 40);
            
            const stats = [
                `Montant total: ${document.getElementById('total-amount').textContent}`,
                `Nombre de transactions: ${document.getElementById('total-transactions').textContent}`,
                `Transaction moyenne: ${document.getElementById('avg-transaction').textContent}`,
                `Taux de paiement: ${document.getElementById('payment-rate').textContent}`
            ];
            
            stats.forEach((stat, i) => {
                doc.text(stat, 14, 50 + (i * 7));
            });
            
            doc.save(`rapport_financier_${new Date().toISOString().split('T')[0]}.pdf`);
            showAlert("Rapport PDF exporté avec succès", "success");
        }

        function exportToExcel() {
            const data = [];
            const rows = document.querySelectorAll('#finance-details-body tr');
            
            rows.forEach(row => {
                const cols = row.querySelectorAll('td');
                if (cols.length === 6) {
                    data.push({
                        'Date': cols[0].textContent,
                        'Type Élève': cols[1].textContent,
                        'Type Frais': cols[2].textContent,
                        'Classe': cols[3].textContent,
                        'Montant': cols[4].textContent,
                        'Méthode': cols[5].textContent
                    });
                }
            });
            
            if (data.length === 0) {
                showAlert("Aucune donnée à exporter", "warning");
                return;
            }
            
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Transactions");
            
            XLSX.writeFile(wb, `transactions_${new Date().toISOString().split('T')[0]}.xlsx`);
            showAlert("Export Excel réussi", "success");
        }

        function exportToCSV() {
            const data = [];
            const rows = document.querySelectorAll('#finance-details-body tr');
            
            rows.forEach(row => {
                const cols = row.querySelectorAll('td');
                if (cols.length === 6) {
                    data.push([
                        cols[0].textContent,
                        cols[1].textContent,
                        cols[2].textContent,
                        cols[3].textContent,
                        cols[4].textContent,
                        cols[5].textContent
                    ]);
                }
            });
            
            if (data.length === 0) {
                showAlert("Aucune donnée à exporter", "warning");
                return;
            }
            
            const headers = ['Date', 'Type Élève', 'Type Frais', 'Classe', 'Montant', 'Méthode'];
            const csvRows = [headers.join(','), ...data.map(row => row.join(','))];
            const csvString = csvRows.join('\n');
            
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            saveAs(blob, `transactions_${new Date().toISOString().split('T')[0]}.csv`);
            showAlert("Export CSV réussi", "success");
        }

        // 11. PARAMÈTRES
        function loadProfileData() {
            if (!currentAdmin) return;
            
            document.getElementById('profile-name').value = currentAdmin.fullName || '';
            document.getElementById('profile-email').value = currentAdmin.email || '';
            document.getElementById('profile-created').value = formatDate(currentAdmin.createdAt?.toDate()) || '';
            
            // Photo de profil
            const photoPreview = document.getElementById('profile-photo-preview');
            if (currentAdmin.photoURL) {
                photoPreview.innerHTML = `<img src="${currentAdmin.photoURL}" class="photo-preview">`;
            } else {
                photoPreview.innerHTML = '<i class="fas fa-user-shield"></i>';
            }
        }

        let profilePhotoFile = null;

        function handleProfilePhotoChange(e) {
            const file = e.target.files[0];
            if (file) {
                if (file.size > 5 * 1024 * 1024) {
                    showAlert("La photo ne doit pas dépasser 5MB", "error");
                    return;
                }
                if (!file.type.startsWith('image/')) {
                    showAlert("Veuillez sélectionner une image valide", "error");
                    return;
                }
                profilePhotoFile = file;
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('profile-photo-preview').innerHTML = `<img src="${e.target.result}" class="photo-preview">`;
                }
                reader.readAsDataURL(file);
            }
        }

        async function updateAdminProfile() {
            if (!currentAdmin) return;
            
            // Uploader la nouvelle photo si elle existe
            let photoURL = currentAdmin.photoURL;
            if (profilePhotoFile) {
                try {
                    // Fonction Cloudinary simplifiée
                    const uploadImage = async (file) => {
                        const formData = new FormData();
                        formData.append('file', file);
                        formData.append('upload_preset', 'cs_lacolombe');
                        formData.append('folder', 'admin');
                        
                        const response = await fetch(`https://api.cloudinary.com/v1_1/diwn8sxtn/image/upload`, {
                            method: 'POST',
                            body: formData
                        });
                        
                        const data = await response.json();
                        return data.secure_url;
                    };
                    
                    photoURL = await uploadImage(profilePhotoFile);
                } catch (error) {
                    console.error("Erreur upload photo:", error);
                    showAlert("Erreur lors du téléchargement de la photo", "error");
                }
            }
            
            // Mettre à jour l'affichage
            currentAdmin.photoURL = photoURL;
            updateAdminPhoto(photoURL);
            document.getElementById('profile-photo-preview').innerHTML = photoURL ? 
                `<img src="${photoURL}" class="photo-preview">` : 
                '<i class="fas fa-user-shield"></i>';
            
            profilePhotoFile = null;
            showAlert("Profil mis à jour avec succès", "success");
        }

        // 12. INITIALISATION
        document.addEventListener('DOMContentLoaded', function() {
            // Initialiser la date pour les rapports
            const today = new Date().toISOString().split('T')[0];
            const lastMonth = new Date();
            lastMonth.setMonth(lastMonth.getMonth() - 1);
            const lastMonthStr = lastMonth.toISOString().split('T')[0];
            
            document.getElementById('start-date').value = lastMonthStr;
            document.getElementById('end-date').value = today;
            
            console.log("Portail Administration initialisé");
        });

        // 13. GESTION DU CLAVIER
        document.addEventListener('keydown', function(e) {
            // Ctrl + S pour rechercher un élève
            if (e.ctrlKey && e.key === 's' && document.getElementById('student-matricule')) {
                e.preventDefault();
                document.getElementById('student-matricule').focus();
            }
            
            // Ctrl + T pour rechercher un enseignant
            if (e.ctrlKey && e.key === 't' && document.getElementById('teacher-matricule')) {
                e.preventDefault();
                document.getElementById('teacher-matricule').focus();
            }
            
            // Ctrl + R pour générer un rapport
            if (e.ctrlKey && e.key === 'r') {
                e.preventDefault();
                document.getElementById('generate-report-btn').click();
            }
        });

    </script>

<script>
// Initialisation immédiate
(function() {
  // Vérifier si Service Worker est supporté
  if ('serviceWorker' in navigator) {
    // Enregistrer le Service Worker immédiatement
    window.addEventListener('load', async () => {
      try {
        const registration = await navigator.serviceWorker.register('./sw.js');
        console.log('✅ Service Worker enregistré avec succès');
        
        // Vérifier les mises à jour toutes les 15 minutes
        setInterval(() => {
          registration.update();
        }, 15 * 60 * 1000);
        
        // Vérifier maintenant
        setTimeout(() => {
          registration.update();
        }, 10000);
        
      } catch (error) {
        console.error('❌ Erreur Service Worker:', error);
      }
    });
  }
  
  // Afficher la version dans la console
  console.log('%c🚀 CS La Colombe - Espace Parent', 'color: #3498db; font-size: 16px; font-weight: bold;');
  console.log('%cSystème de mise à jour en temps réel activé', 'color: #2ecc71;');
  
})();

// Fonctions utilitaires
window.reloadApp = function() {
  window.location.reload();
};

window.clearAppCache = function() {
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.getRegistrations().then(registrations => {
      registrations.forEach(registration => {
        registration.unregister();
      });
    });
  }
  
  caches.keys().then(cacheNames => {
    cacheNames.forEach(cacheName => {
      caches.delete(cacheName);
    });
  });
  
  localStorage.clear();
  sessionStorage.clear();
  
  setTimeout(() => {
    window.location.reload();
  }, 1000);
};
</script>
<script>

 Afficher une notification de mise à jour
function showUpdateNotification(newVersion, previousVersion) {
  const updateToast = document.createElement('div');
  updateToast.className = 'notification-toast success';
  updateToast.innerHTML = `
    <div class="notification-header">
      <div class="notification-title">
        <i class="fas fa-sync-alt"></i> Mise à jour disponible
      </div>
      <button class="notification-close">&times;</button>
    </div>
    <div class="notification-body">
      <p>Une nouvelle version (${newVersion}) de l'application est disponible !</p>
      <p><small>Version précédente: ${previousVersion || 'inconnue'}</small></p>
      <div class="notification-actions" style="margin-top: 10px;">
        <button class="btn btn-primary btn-sm" id="update-app-btn">
          <i class="fas fa-redo"></i> Mettre à jour
        </button>
        <button class="btn btn-secondary btn-sm" id="later-update-btn">
          Plus tard
        </button>
      </div>
    </div>
  `;
  
  document.body.appendChild(updateToast);
  
  setTimeout(() => {
    updateToast.classList.add('show');
  }, 1000);
  
  // Gérer le bouton de mise à jour
  document.getElementById('update-app-btn').addEventListener('click', () => {
    updateToast.classList.remove('show');
    setTimeout(() => updateToast.remove(), 300);
    
    // Recharger la page pour activer la nouvelle version
    window.location.reload();
  });
  
  // Gérer le bouton "Plus tard"
  document.getElementById('later-update-btn').addEventListener('click', () => {
    updateToast.classList.remove('show');
    setTimeout(() => updateToast.remove(), 300);
  });
  
  // Fermer le toast
  updateToast.querySelector('.notification-close').addEventListener('click', () => {
    updateToast.classList.remove('show');
    setTimeout(() => updateToast.remove(), 300);
  });
}

// Afficher une notification de mise à jour obligatoire
function showMandatoryUpdateNotification(newVersion, currentVersion, updateUrl) {
  const mandatoryToast = document.createElement('div');
  mandatoryToast.className = 'notification-toast danger';
  mandatoryToast.style.zIndex = '99999'; // Assurez-vous qu'il est au-dessus de tout
  mandatoryToast.innerHTML = `
    <div class="notification-header">
      <div class="notification-title">
        <i class="fas fa-exclamation-triangle"></i> Mise à jour REQUISE
      </div>
      <button class="notification-close" disabled>&times;</button>
    </div>
    <div class="notification-body">
      <p><strong>Mise à jour obligatoire !</strong></p>
      <p>La version ${newVersion} est requise pour continuer à utiliser l'application.</p>
      <p><small>Votre version actuelle: ${currentVersion}</small></p>
      <div class="notification-actions" style="margin-top: 10px;">
        <button class="btn btn-warning btn-sm" id="mandatory-update-btn">
          <i class="fas fa-download"></i> Mettre à jour maintenant
        </button>
      </div>
    </div>
  `;
  
  document.body.appendChild(mandatoryToast);
  
  setTimeout(() => {
    mandatoryToast.classList.add('show');
    
    // Bloquer l'interface utilisateur
    const overlay = document.createElement('div');
    overlay.style.position = 'fixed';
    overlay.style.top = '0';
    overlay.style.left = '0';
    overlay.style.width = '100%';
    overlay.style.height = '100%';
    overlay.style.backgroundColor = 'rgba(0,0,0,0.7)';
    overlay.style.zIndex = '99998';
    overlay.id = 'update-overlay';
    document.body.appendChild(overlay);
  }, 500);
  
  // Gérer le bouton de mise à jour obligatoire
  document.getElementById('mandatory-update-btn').addEventListener('click', () => {
    // Rediriger vers l'URL de mise à jour
    window.location.href = updateUrl;
  });
  
  // Empêcher la fermeture
  mandatoryToast.querySelector('.notification-close').addEventListener('click', (e) => {
    e.preventDefault();
    showToast('Cette mise à jour est obligatoire pour continuer à utiliser l\'application', 'warning');
  });
}

// Vérifier les mises à jour manuellement
async function checkForUpdates() {
  try {
    const response = await fetch(`/version-check.json?t=${Date.now()}`);
    const data = await response.json();
    
    // Vérifier la version actuelle depuis le service worker
    if (navigator.serviceWorker.controller) {
      navigator.serviceWorker.controller.postMessage({
        type: 'GET_VERSION'
      });
    }
    
    // Comparer avec la version stockée localement
    const currentVersion = localStorage.getItem('app_version');
    
    if (currentVersion !== data.version) {
      // Nouvelle version disponible
      showUpdateNotification(data.version, currentVersion);
      localStorage.setItem('app_version', data.version);
      
      // Si la mise à jour est obligatoire
      if (data.mandatory === true) {
        showMandatoryUpdateNotification(data.version, currentVersion, data.updateUrl);
      }
    }
    
  } catch (error) {
    console.error('Erreur lors de la vérification des mises à jour:', error);
  }
}

// Vérifier la version au chargement
window.addEventListener('load', () => {
  // Stocker la version actuelle
  if (!localStorage.getItem('app_version')) {
    localStorage.setItem('app_version', '1.0.0');
  }
  
  // Vérifier les mises à jour après 5 secondes
  setTimeout(() => {
    checkForUpdates();
  }, 5000);
});

// Écouter les événements de mise à jour du service worker
let refreshing = false;
navigator.serviceWorker.addEventListener('controllerchange', () => {
  if (!refreshing) {
    refreshing = true;
    window.location.reload();
  }
});
</script>

</body>
</html>